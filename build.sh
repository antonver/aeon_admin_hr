#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ –¥–ª—è Render
echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞..."

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install -r backend/requirements.txt

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p backend/static

# –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ –±—ç–∫–µ–Ω–¥ (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —É–∂–µ —Å–æ–±—Ä–∞–Ω –≤ render.yaml)
echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
if [ -d "frontend/build" ]; then
    echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
    rm -rf backend/static/*
    echo "üìã –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
    cp -r frontend/build/* backend/static/
    
    # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ - –ø–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ static/static/ –≤ static/
    if [ -d "backend/static/static" ]; then
        echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫ (static/static/ -> static/)..."
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º CSS —Ñ–∞–π–ª—ã
        if [ -d "backend/static/static/css" ]; then
            mkdir -p backend/static/css
            mv backend/static/static/css/* backend/static/css/ 2>/dev/null || true
        fi
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º JS —Ñ–∞–π–ª—ã  
        if [ -d "backend/static/static/js" ]; then
            mkdir -p backend/static/js
            mv backend/static/static/js/* backend/static/js/ 2>/dev/null || true
        fi
        # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        rmdir backend/static/static/css 2>/dev/null || true
        rmdir backend/static/static/js 2>/dev/null || true
        rmdir backend/static/static 2>/dev/null || true
        echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞"
    fi
    
    echo "‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤:"
    ls -la backend/static/
    ls -la backend/static/js/ 2>/dev/null || echo "‚ö†Ô∏è  JS —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    ls -la backend/static/css/ 2>/dev/null || echo "‚ö†Ô∏è  CSS —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ index.html —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—É—Ç–∏
    echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º index.html..."
    if ls backend/static/js/main.*.js 1> /dev/null 2>&1; then
        echo "‚úÖ JS —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    else
        echo "‚ùå JS —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
    
    if ls backend/static/css/main.*.css 1> /dev/null 2>&1; then
        echo "‚úÖ CSS —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"
    else
        echo "‚ùå CSS —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
else
    echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è frontend/build –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    mkdir -p backend/static
fi

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üóÑÔ∏è  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
cd backend
python init_heroku_db.py

echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" 